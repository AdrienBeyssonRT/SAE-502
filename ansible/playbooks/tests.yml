---
- name: Tests automatiques du pare-feu et vérification des logs
  hosts: all
  become: yes
  vars:
    firewall_host: "firewall"
    test_ports:
      - 22
      - 80
      - 443
      - 445
      - 3389
  
  tasks:
    - name: Vérifier que les conteneurs sont en cours d'exécution
      command: docker ps --format "{{ '{{' }}.Names{{ '}}' }}"
      register: running_containers
      changed_when: false

    - name: Afficher les conteneurs en cours d'exécution
      debug:
        var: running_containers.stdout_lines

    - name: Test 1 - Ping vers le firewall
      command: docker exec client ping -c 3 {{ firewall_host }}
      register: ping_result
      changed_when: false
      failed_when: false

    - name: Afficher le résultat du ping
      debug:
        var: ping_result.stdout_lines

    - name: Vérifier le statut UFW et le logging
      command: docker exec firewall ufw status verbose
      register: ufw_status
      changed_when: false
      failed_when: false

    - name: Afficher le statut UFW
      debug:
        var: ufw_status.stdout_lines

    - name: Test 2 - Générer des connexions TCP réelles pour créer des logs UFW
      shell: |
        docker exec client bash -c "
          echo 'Test port 445 (SMB) - DOIT ÊTRE BLOQUÉ...'
          timeout 2 bash -c '</dev/tcp/{{ firewall_host }}/445' 2>&1 || true
          sleep 1
          echo 'Test port 3389 (RDP) - DOIT ÊTRE BLOQUÉ...'
          timeout 2 bash -c '</dev/tcp/{{ firewall_host }}/3389' 2>&1 || true
          sleep 1
          echo 'Test port 139 (NetBIOS) - DOIT ÊTRE BLOQUÉ...'
          timeout 2 bash -c '</dev/tcp/{{ firewall_host }}/139' 2>&1 || true
          sleep 1
          echo 'Test port 80 (HTTP) - DOIT ÊTRE BLOQUÉ...'
          timeout 2 bash -c '</dev/tcp/{{ firewall_host }}/80' 2>&1 || true
          sleep 1
          echo 'Test port 22 (SSH) - DOIT ÊTRE AUTORISÉ...'
          timeout 2 bash -c '</dev/tcp/{{ firewall_host }}/22' 2>&1 || true
        "
      register: tcp_tests
      changed_when: false
      failed_when: false

    - name: Afficher les résultats des tests TCP
      debug:
        var: tcp_tests.stdout_lines

    - name: Vérifier les logs UFW dans le firewall (dans les 3 secondes)
      command: docker exec firewall tail -30 /var/log/kern.log | grep -i ufw || echo "Aucun log UFW trouvé"
      register: ufw_logs_check
      changed_when: false
      failed_when: false

    - name: Afficher les logs UFW trouvés
      debug:
        var: ufw_logs_check.stdout_lines

    - name: Attendre la propagation des logs
      pause:
        seconds: 5

    - name: Vérifier les logs dans le collecteur
      shell: docker exec logcollector sh -c "tail -n 30 /var/log/firewall/*.log 2>/dev/null | grep -i ufw | tail -20" || echo "Aucun log UFW dans le collecteur"
      register: logs_check
      changed_when: false
      failed_when: false

    - name: Afficher les logs récents du collecteur
      debug:
        var: logs_check.stdout_lines

    - name: Vérifier l'API de supervision
      uri:
        url: http://localhost:5000/api/stats
        method: GET
      register: supervision_stats
      changed_when: false
      failed_when: false

    - name: Afficher les statistiques de supervision
      debug:
        var: supervision_stats.json

    - name: Résumé des tests
      debug:
        msg:
          - "Tests terminés!"
          - "Consultez les logs ci-dessus pour voir les résultats"
          - "Accédez à http://localhost:5000 pour voir la supervision visuelle"
          - "Les tentatives de connexion devraient apparaître dans les logs"





